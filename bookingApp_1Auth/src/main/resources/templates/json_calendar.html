<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-spring4-4.dtd">

<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>



  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.4/index.global.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
        rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.4/index.global.min.js"></script>
<!--  <script src="https://cdnjs.cloudfare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script>-->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <link rel="stylesheet"
        href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"/>
 <script
          src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<!--  <script src="https://code.jquery.com/jquery-2.2.4.min.js" />-->

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>

  <style>

    body {
      margin: 40px 10px;
      padding: 0;
      font-family: "Lucida Grande",Helvetica,Arial,Verdana,sans-serif;
      font-size: 14px;
    }

    #calendar {
      max-width: 900px;
      margin: 0 auto;
    }
    .no-titlebar .ui-dialog-titlebar {
      display: none;
    }
    #description { margin-bottom:12px; width:100%; padding: .4em; }

    #fieldset { padding:0; border:0; margin-top:25px; height: 200px;}
    .hide_block
    {
      display:none  !important;
    }

    /*.display_block*/
    /*{*/
    /*  display:block !important;*/
    /*}*/

  </style>
</head>
<body>

<div id="header">
  <h1>Calendar</h1>
</div>

<div id='script-warning'  >
  <div class="btn-group-vertical btn-group-sm" role="group" aria-label="author button">
<!--    <p>Author: </p>
th:text="${param.}"-->
  <div class="btn btn-info">
    <button type="button" class="btn btn-info" id="whichuser">Author:</button>
  </div>
    <form th:action="@{/logout}" method="post">
      <button type="submit" class="btn btn-danger">Logout</button>
    </form>
  </div>


  </div>

<div>
  <form id='loading'>
  <!--  <div class="container">-->
  <!--    <div class="row row-cols-4">-->
  <!--      <div class="col"><input type="radio" value="ΔΕΠΥ Α" id="A" name="DEPY" checked="checked" />ΔΕΠΥ Α</div>-->
  <!--      <div class="col"><input type="radio" value="ΔΕΠΥ Β" id="B" name="DEPY" />ΔΕΠΥ Β</div>-->
  <!--      <div class="col"><input type="radio" value="ΔΕΠΥ Γ" id="C" name="DEPY" />ΔΕΠΥ Γ</div>-->

  <!--    </div>-->

  <!--&lt;!&ndash;    <div class="row row-cols-4">&ndash;&gt;-->
  <!--&lt;!&ndash;      <form th:action="@{/logout}" method="post" sec:authorize="isAuthenticated()">&ndash;&gt;-->
  <!--&lt;!&ndash;        <div class="form-group ">&ndash;&gt;-->
  <!--&lt;!&ndash;          <button type="submit" class="btn btn-danger">Logout</button>&ndash;&gt;-->
  <!--&lt;!&ndash;        </div>&ndash;&gt;-->
  <!--&lt;!&ndash;      </form>&ndash;&gt;-->
  <!--&lt;!&ndash;    </div>&ndash;&gt;-->
  <!--  </div>-->
  <div class="container">
    <div class="form-check">
      <input class="form-check-input" type="radio" name="DEPY" id="A" value="ΔΕΠΥ Α" checked>
      <label class="form-check-label" for="A">
        ΔΕΠΥ Α
      </label>
    </div>
    <div class="form-check">
      <input class="form-check-input" type="radio" name="DEPY" id="B" value="ΔΕΠΥ Β">
      <label class="form-check-label" for="B">
        ΔΕΠΥ Β
      </label>
    </div>
    <div class="form-check">
      <input class="form-check-input" type="radio" name="DEPY" id="C" value="ΔΕΠΥ Γ">
      <label class="form-check-label" for="C">
        ΔΕΠΥ Γ
      </label>
    </div>
  </div>
  </form><hr>
</div>

  <div id='calendar'  th:id="calendar"></div>


<!--  <div>-->
<!--    <label for ></label>-->
<!--    <input type="radio" value="ΔΕΠΥ Α" id="A" name="DEPY" />ΔΕΠΥ Α-->
<!--    <input type="radio" value="ΔΕΠΥ Β" id="B" name="DEPY" />ΔΕΠΥ Β-->
<!--    <input type="radio" value="ΔΕΠΥ Γ" id="C" name="DEPY" />ΔΕΠΥ Γ-->
<!--  </div>-->


</body>
</html>
<script>

  const displayInputForDate = document.getElementById('startDate');
  const displayInputForDateEnd = document.getElementById('endDate');
  const repetitionBook = document.getElementById('bookRepeat');
  const depyA = document.querySelector("#A");
  const depyB = document.querySelector("#B");
  const depyC = document.querySelector("#C");
  let depyId ='';
  let whichLab ='';
  let whichLabUser = '';
  let whichLabUsername = '';
  let dateStart = '';
  let dateEnd = '';
  let titleEvent = '';
  let newEvent = null;
  let myModal = null;
  let editDialog = null;
  let modifiedEvent = null;
  let token = null;


  // token = sessionStorage.getItem("token");
  //
  // async function validateUserCredentials() {
  //
  //   let validateUser = await fetch("/validate-user",{
  //     method: 'GET',
  //
  //     headers:{
  //       'Authorization': `Bearer ${token}`
  //     }
  //   })
  //           .then(response => {
  //             if (response.ok) {
  //               window.location.href = "/json_calendar";
  //             } else {
  //                 window.location.href = "/login";
  //             }
  //           });
  //
  //   // let getValidatedUser = await validateUser.json();
  //
  //   // return getValidatedUser;
  // }

  // whichLabUser = await validateUserCredentials();
  // console.log("Which Author logged in " + whichLabUser.text());

  whichLabUser = document.getElementById("whichuser");
  whichLabUsername = document.documentURI.split("?")[1].split("=")[1];
  whichLabUser.textContent = "Hi, " + document.documentURI.split("?")[1].split("=")[1];
  console.log("which user logged in:"+whichLabUser.textContent);


 function saveEvent() {}
  function removeEvent() {}

  function showInputButtons() {


      // let displayInputForDate = document.getElementById('startDate');
      document.getElementById('startDate').setAttribute('type', 'datetime-local');
      document.getElementById('endDate').setAttribute('type','datetime-local');

  }
  function findWhichLab() {

    let lab = null;

    if (depyA.checked) {
      lab = depyA.value;
      depyId = depyA.id;
    }
    if (depyB.checked) {
      lab = depyB.value;
      depyId = depyB.id;
    }
    if (depyC.checked) {
      lab = depyC.value;
      depyId = depyC.id;
    }
    return lab;
  }
  //
  // function checkRadio() {
  //   document.getElementById('bookRepeat').checked = true;
  //   showInputButtons();
  // }
  //
  // function unCheckRadio() {
  //   document.getElementById('bookRepeat').checked = false;
  //   displayInputForDate.setAttribute('type','hidden');
  //   displayInputForDateEnd.setAttribute('type','hidden');
  // }
  //
  // function changeRepeatSele(event) {
  //
  //   let val = event.target.checked;
  //   // if (radioState === false) {
  //   if (val) {
  //     checkRadio();
  //     radioState = true;
  //   }
  //   // if (radioState === true) {
  //   if (!val) {
  //     unCheckRadio();
  //     radioState = false;
  //   }
  //
  // }

  function modalSaveAction(e) {
    e.preventDefault();
    myModal.hide();
    addEvent();

  }

  async function modifyEvent(){
    //event.preventDefault();

    // console.log("modifyEvent: changing event with new data " + );

    let resultOfModifiedEventJson = await fetch("/updateBooking", {
      method: 'POST',
      body: JSON.stringify(modifiedEvent),
      headers:{
        'Content-Type': 'application/json'
      }
    });

    let resultOfModifiedEvent = await resultOfModifiedEventJson.json();

    return resultOfModifiedEvent;
  }

  async function addEvent() {

    event.preventDefault();

    console.log("addEvent: adding new event with data " + newEvent.title + " " + newEvent.start + " " +newEvent.end);
    let resultFromAddEventJson = await fetch("/newbooking",{
      method: 'POST',
      body: JSON.stringify(newEvent),
      headers:{
        'Content-Type': 'application/json'
      }
    });

    let resultFromAddEvent = await resultFromAddEventJson.json();

    //
    // if (!resultFromAddEvent) {
    //   console.log("reserve lab where there is reservation");
    //   alert("these dates are reserved for this lab");
    // }
    // else {
    //   console.log("return from controller " + resultFromAddEvent.title);
    //   alert("reservation made!");
    // }

    return resultFromAddEvent;

  }



  function editEvent(event, element) {

    var eventStartDate = event.start;
    var eventEndDate = event.end;

    console.log("editEvent: event start date " + eventStartDate);
    console.log("editEvent: event end date " + eventEndDate);
    console.log("test dialog " + event.target.title);
    console.log("test dialog " + event.target.start);
    console.log("test dialog " + event.target.end);

    // var eventStart = moment(event.start).format("YYYY-MM-DD HH:mm:ss"); //moment(event.start);
    // var eventEnd = moment(event.end).format("YYYY-MM-DD HH:mm:ss");

    // alert (eventStart + "   " + eventEnd + "   " + event.finish);
    // var modifiedEvent = {
    //   labname: whichLab,
    //   start: eventStart,
    //   end: eventEnd,
    // }
    // modtitle.value = event.title;
    // moddescription.value = event.description;
    // modstartdateandtime.value = eventStart;
    // modenddateandtime.value = eventEnd;
    // moduid.value = event.id;


    // editDialog.dialog( "open" );

    editDialog = $("#edit-dialog-form").dialog({
      autoOpen: false,
      height: 450,
      width: 350,
      modal: true,
      buttons: {
        Save: saveEvent,
        Delete: removeEvent,
        Cancel: function () {
          $(this).dialog("close");
        }
      },
      close: function () {
        $(this).dialog("close");
      }
    });

    editDialog.dialog("open");

    // $("edit-dialog-form").dialog("open");

  }

  function createModal(dateStartStr,timeStartStr,dateEndStr,timeEndStr) {

    console.log("createModal: create modal with modalDate and time, labname,username");
    myModal = new bootstrap.Modal(document.getElementById('exampleModal'));
    var modalDateStart = document.getElementById('startDateFromCal').innerText = dateStartStr + "  at:" + timeStartStr;
    var modalDateEnd = document.getElementById('endDateFromCal').textContent = dateEndStr + "  at:" + timeEndStr;
    var modalLabname = document.getElementById('labname');
    modalLabname.textContent = whichLab;

    var modalUsername = document.getElementById('labuser').textContent = 'dimi';

    // var modalEventTitle = document.createElement('input');
    // modalEventTitle.setAttribute('type',"text");
    // modalEventTitle.setAttribute('id','eventTitle')
    // modalEventTitle.setAttribute('autocomplete',"off");
    // modalEventTitle.classList.add("form-control");
    //
    // myModal.appendChild(modalEventTitle);

  }
 async function getAllBookings() {
   const allBookings = await fetch("/allBookings",{
     method: 'GET',
     headers: {
       'Content-Type': 'application/json'
     }
   });
   let numRecsStr = await allBookings.text();
   console.log("getAllBookings: number of records:" + numRecsStr);
   let numRecs = Math.floor(numRecsStr);

   newEvent = {
     id: numRecs+1,
     username: whichLabUsername,
     labname: whichLab,
     start: dateStart,
     end: dateEnd,
  //   title: titleEvent
   };

  }

  // whichLab = findWhichLab();
  // console.log("default value of DEPY ",depyId);
  // console.log("default value of DEPY ",whichLab);
  //  let urlA = '/displayBookings'+depyId;
  //
  //  console.log("first url controller ",urlA);
//let urlA = '/displayBookingsB';

  var radioForm = document.getElementById('loading');

  const radioHandler = (event) => {
    console.log("Radio clicked value ", radioForm["DEPY"].value);
    depyId = radioForm["DEPY"].value;
    console.log("in radio handler ",depyId);

    var href = window.location.href;
    //loadCalendar();

    //document.getElementById("calendar").load(href + " #calendar");

    //window.location.reload();
    //location.reload();
    //loadCalendar();

    whichLab = findWhichLab();
    console.log("whichLab element is: ", whichLab);
    console.log("whichLabUser element is :", whichLabUsername);
    urlA = '/displayBookings' + depyId;
    console.log("url events controller ", urlA);

    loadCalendar();


  };
  radioForm.addEventListener("change", radioHandler);


  // document.getElementById('loading').addEventListener('', function () {
  //   calendar.render();},true );

  whichLab = findWhichLab();
  console.log("whichLab element is: ", whichLab);
  console.log("whichLabUser element is :", whichLabUsername);
  urlA = '/displayBookings' + depyId;
  console.log("url events controller ", urlA);

  // const allEvents = await getAllEvents().then();
  //
  // console.log("there is an errror..");

  function loadCalendar() {

    //location.reload();

    //calendar.load('json_calendar.html #calendar');
    calendar.render();
    //location.reload();
  }

  // document.addEventListener('DOMContentLoaded',function () {
  //
  //
  //   var id = calendar.getEventById('15');
  //   console.log("event information for last event: " + id);
  //   calendar.render();
  //
  //
  //
  // });

  async function getAllEvents() {
    const eventsAll = await fetch(urlA,{
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    return await eventsAll.json();
  }


  let calendarEl = document.getElementById('calendar');
  const calendar = new FullCalendar.Calendar(calendarEl, {


    initialView: 'timeGridWeek',
    selectable: true,
    eventDurationEditable: true,
    businessHours: {
      startTime: '08:00',
      endTime: '18:00',
    },
    slotMinTime: "08:00",     // Earliest time displayed in the calendar
    slotMaxTime: "18:00",
    customButtons: {
      reserveButton: {
        text: 'new reservation',
        icon: 'square',
        click: function() {
          alert("create a new booking");
        }
      }
    },
    footerToolbar: {
      start: 'reserveButton',
      center: '',
    },


    // [
    //         {
    //           url: '/displayBookings',
    //           type: 'GET',
    //           color: 'yellow',
    //           textColor: 'black',
    //           error: function () {
    //             alert("There was an error from getting booked classes for labs");
    //           }
    //         }
    //         ]
//#378006
    //#FFC107
    events:
            {
              url: urlA,
              type: 'GET',
              color: '#FFC107',
              textColor: 'black'
            },
    //events: [allEvents],
    // red areas where no events can be dropped
    dateClick: function (info)
    {
      alert("date clicked:"+info.dateStr);

    },
    select: async function(info) {

      let template = null;

      whichLab = findWhichLab();

      let dateStartStr = info.startStr.split('T')[0];
      let timeStartStr = info.startStr.split('T')[1].split('+')[0];

      dateStart = dateStartStr +" " + timeStartStr;
      console.log("date and time in string:" + dateStart);

      let dateEndStr = info.endStr.split('T')[0];
      let timeEndStr = info.endStr.split('T')[1].split('+')[0];

      titleEvent = info.title;
      dateEnd = dateEndStr + " " + timeEndStr;
      console.log("date and time end in string:" + dateEnd);

      createModal(dateStartStr,timeStartStr,dateEndStr,timeEndStr);

      await  getAllBookings().then();
      //newEvent.title = modalEventTitle.value.trim();
      myModal.show();
      let modalButtonClicked = false;

      var modalSaveChanges = document.getElementById('modalSave');

      // var modalSaveChanges = document.getElementById('modalClose');

      modalSaveChanges.addEventListener('click',async function (e) {
        e.preventDefault();
        var modalEventTitle = document.getElementById('eventTitle');
        console.log('submit data from modal '+ modalSaveChanges.id);
        console.log('title event ' + modalEventTitle.value.trim());
        myModal.hide();
        newEvent.title = modalEventTitle.value.trim();
        let result = await addEvent().then();
        if (!result) {
          alert("Try to reserve lab in reserved date");
        }
        else {

          //this reload from database entry and displays event on calendar
          location.reload();

          //calendar.render();
        }
        console.log("result from adding Event "+ result);



      },true);

      console.log("event with: " + newEvent.id + " "+ newEvent.start +" "+ newEvent.end + " "+ newEvent.title);

    },
    eventChange: async function (info) {

      console.log("eventChange: information for event to change: "+info.event.id + " " + info.event.title + " " + info.event.startStr);


      dateStart = info.event.startStr.split('T')[0] + " " + info.event.startStr.split('T')[1].split('+')[0];

      let dateEndStr = info.event.endStr.split('T')[0];
      let timeEndStr = info.event.endStr.split('T')[1].split('+')[0];
      dateEnd = dateEndStr + " " + timeEndStr;

      modifiedEvent = {
        id: info.event.id,
        username: whichLabUser,
        labname: whichLab,
        start: dateStart,
        end: dateEnd
        //   title: titleEvent
      };

      console.log("eventChange: change date " + dateEnd);

      let result = await modifyEvent().then();
      if (!result) {
        alert("modification can't be done");
      }
      else {
        alert("Time is changed!");
      }


    }
    // eventClick: function(event,element) {
    //
    //
    //   console.log("eventClick: event " + event.type);
    //   editEvent(event,element);
    //
    //   //this is a wrong getting element for getting sources
    //   //so what if
    //
    //     // editDialog.dialog("open");
    //   // });
    //
    //   // editEvent(event,element);
    // }


    // loading: function(bool) {
    //   $('#loading').toggle(bool);
    // }

  });



 document.addEventListener('DOMContentLoaded',loadCalendar,true);

  // window.addEventListener('load', function() {
  //   setTimeout(function() {
  //     var e = document.getElementsByClassName("btn-close")[0];
  //     e.setAttribute('onclick', "myModal.close('btn-close');  location.reload();");
  //   }, 1600);
  // });
</script>


<div  id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" class="modal fade"  aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Add Event</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form autocomplete="off" action="">
          <div class="form-group">
            <h6>Adding Event with the following details</h6>
            <input id="eventTitle" type="text" autocomplete="nope" class="form-control"  /><br>

            <div>
              <label for="startDateFromCal"><b>Start: </b></label>
              <span id="startDateFromCal"></span>
            </div>
            <div>
              <label for="endDateFromCal"><b>End: </b></label>
              <span id="endDateFromCal"></span>
            </div>
            <div>
              <label for="labname"><b>Lab: </b></label>
              <span id="labname"></span>
            </div>
            <div>
              <label for="labuser" ><b>Author: </b></label>
              <span id="labuser"></span>
            </div>

<!--            <div class="btn-group btn-group-sm" role="group" aria-label="Basic radio toggle button group">-->
<!--              <label><b>Repeat Reservation </b></label> &nbsp;-->
<!--              <input type="radio" class="btn-check" name="btnradio" id="btnradio1" autocomplete="off" checked>-->
<!--              <label class="btn btn-outline-primary" for="btnradio1">No</label>-->

<!--              <input type="radio" class="btn-check" name="btnradio" id="btnradio2" autocomplete="off">-->
<!--              <label class="btn btn-outline-primary" for="btnradio2">Yes</label>-->


<!--              <div class="input-group input-group-sm" aria-hidden="true" >-->
<!--                <div class="input-group-text" id="btnGroupAddon"></div>-->
<!--                <input type="text" class="form-control" placeholder="Input group example" aria-label="Input group example" aria-describedby="btnGroupAddon">-->
<!--              </div>-->

<!--            </div>-->


          </div>
        </form>

      </div>
      <div class="modal-footer">
        <div>

        </div>
        <button type="button"  id="modalClose" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" id="modalSave" class="btn btn-primary">Save</button>
      </div>
    </div>
  </div>
</div>

<div id="edit-dialog-form" title="Modify an Event" class="ui-helper-hidden">
  <form id="edit-event-form">
    <fieldset>
      <label >title</label>
      <input type="text" name="modtitle" id="modtitle" value="New Event" class="text ui-widget-content ui-corner-all"/>

      <label>description:</label>
      <input type="text" name="moddescription" id="moddescription" value="" class="text ui-widget-content ui-corner-all "/>

      <label for="modstartdateandtime">starts:</label>
      <input type="datetime-local" id="modstartdateandtime"/>
      <br></br>
      <label for="modenddateandtime">ends:</label>
      <input type="datetime-local" id="modenddateandtime"/>
      <input type="hidden" name="moduid" id="moduid"/>
      <input type="submit" tabindex="-1" style="position:absolute; top:-1000px"/>
    </fieldset>
  </form>
</div>